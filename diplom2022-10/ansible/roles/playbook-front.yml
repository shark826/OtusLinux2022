---
- name: Set up WordPress Server
  #Указываем имя хоста или группу, которые будем настраивать
  hosts: frontserver
  #Параметр выполнения модулей от root-пользователя
  become: yes
  #Указание файла с дополнителыми переменными (понадобится при добавлении темплейтов)
  vars_files:
    - ../vars/default.yml
    
  tasks:
  #Update system
  - name: Update system
    apt: 
      update_cache: yes
      upgrade: dist
      state: latest
      force_apt_get: yes
      cache_valid_time: 3600
      autoremove: yes

  #Install LAMP  

  - name: Install LAMP Packages
    apt: name={{ item }} update_cache=yes state=latest
    loop: [ 'mc','curl','iptables','apache2', 'python3-pymysql', 'php', 'php-mysql', 'libapache2-mod-php' ]
    tags: [ system ]
  
  # Install PHP Extensions
  - name: Install PHP Extensions
    apt: name={{ item }} update_cache=yes state=latest
    loop: "{{ php_modules }}"
    tags: [ system ]


  # Security Settings For Debian
  
  - name: Iptables flush filter
    iptables:
      chain: "{{ item }}"
      flush: yes
    with_items:  [ 'INPUT', 'FORWARD', 'OUTPUT' ]

  # PING
  - name: Allow icmp Ping
    iptables:
        chain: INPUT
        protocol: icmp
        jump: ACCEPT
        
  - name: Allow TCP Ports
    iptables:
      chain: INPUT
      rule_num: '1'
      action: insert
      protocol: tcp
      jump: ACCEPT
      destination_port: "{{ item }}"
    loop: [ '22','53','80','443','3306','9090', '9093', '9094', '9100' ]

  - name: Allow UDP Ports
    iptables:
      chain: INPUT
      rule_num: '1'
      action: insert
      protocol: udp
      jump: ACCEPT
      destination_port: "{{ item }}"
    loop: [ '22','53','80','443','3306','9090', '9093', '9094', '9100' ]

  - name: Allow UDP Ports
    iptables:
      chain: INPUT
      action: insert
      ctstate: ESTABLISHED,RELATED
      jump: ACCEPT
      

  - name: Set the policy for the INPUT chain to DROP
    iptables:
      chain: INPUT
      policy: DROP