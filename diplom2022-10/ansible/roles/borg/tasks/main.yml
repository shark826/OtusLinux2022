---
# tasks file for borg
# - name: install epel
#   ansible.builtin.yum:
#     name:
#       - epel-release      
#     state: latest

- name: install borg-backup
  ansible.builtin.apt:
    name:
      - borgbackup      
    state: latest
  when: ansible_os_family == "Debian"

- name: install borg-backup
  ansible.builtin.yum:
    name:
      - borgbackup      
    state: latest
  when: ansible_os_family == "RedHat"

# - name: Add the user 'borg'
#   ansible.builtin.user:
#     name: borg
#     home: '/home/borg'
#   when: (ansible_hostname == "backup")


- name: mkdir .ssh
  file:
    path: ~/.ssh
    state: directory
    # owner: borg
    # group: borg
    mode: '0700'


- name: copy ssh-key
  copy:
    src: borg
    dest: ~/.ssh/id_rsa
    # owner: borg
    # group: borg
    mode: '0600'

- name: copy ssh-config
  copy:
    src: sshconfig
    dest: ~/.ssh/config
    # owner: borg
    # group: borg
    mode: '0400'

- name: Stop and Start ssh
  service:
    name: sshd
    state: restarted

- name: init borg repo for front
  command: borg init -e none borg@10.0.0.50:front_repo
  when: (ansible_hostname == "frontserver")

- name: init borg repo for mysql
  command: borg init -e none borg@10.0.0.50:mysql_repo
  when: (ansible_hostname == "mysqlservernode2")

- name: init borg repo for drbd
  command: borg init -e none borg@10.0.0.50:drbd_repo
  when: (ansible_hostname == "drbdnode1")

  # when: (ansible_hostname == "client1") or
  #       (ansible_hostname == "client2") or
  #       (ansible_hostname == "client3")


   
    # borg create -C zstd borg@10.0.0.50:front_repo::front-etc-`date +%Y%m%d_%H%M%S` /etc
    
- name: copy cron front
  copy:
    src: cron_borg_front.sh
    dest: /root/cron_borg_front.sh
    # owner: borg
    # group: borg
    mode: 'a+x'

- name: crontab borg repo for front
  command: echo  '0 */3 * * * root /root/cron_borg_front.sh' >> /etc/crontab
  when: (ansible_hostname == "frontserver")

- name: copy cron mysql
  copy:
    src: cron_borg_mysql.sh
    dest: /root/cron_borg_mysql.sh
    # owner: borg
    # group: borg
    mode: 'a+x'

- name: crontab borg repo for mysql
  command: echo  '0 */3 * * * root /root/cron_borg_mysql.sh' >> /etc/crontab
  when: (ansible_hostname == "mysqlservernode2")


- name: copy cron drbd
  copy:
    src: cron_borg_drbd.sh
    dest: /root/cron_borg_drbd.sh
    # owner: borg
    # group: borg
    mode: 'a+x'

- name: crontab borg repo for drbd
  command: echo  '0 */6 * * * root /root/cron_borg_drbd.sh' >> /etc/crontab
  when: (ansible_hostname == "drbdnode1")